<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>json2tree.com | JSON Visualizer | JSON to Tree | JSON to Table</title>
  <style>
    /* Variables para temas */
    :root {
      --color-bg-primary: #ffffff;
      --color-bg-secondary: #f9fafb;
      --color-text-primary: #1f2937;
      --color-text-secondary: #6b7280;
      --color-border: #e5e7eb;
      --color-border-light: #f3f4f6;
      --color-hover: #f3f4f6;
      --color-error-bg: #fee2e2;
      --color-error-text: #b91c1c;
      --color-string: #16a34a;
      --color-number: #2563eb;
      --color-boolean: #9333ea;
      --color-null: #dc2626;
      --color-muted: #9ca3af;
    }

    /* Tema oscuro */
    [data-theme="dark"] {
      --color-bg-primary: #1f2937;
      --color-bg-secondary: #111827;
      --color-text-primary: #f9fafb;
      --color-text-secondary: #d1d5db;
      --color-border: #374151;
      --color-border-light: #374151;
      --color-hover: #374151;
      --color-error-bg: #7f1d1d;
      --color-error-text: #fecaca;
      --color-string: #4ade80;
      --color-number: #60a5fa;
      --color-boolean: #c084fc;
      --color-null: #f87171;
      --color-muted: #9ca3af;
    }

    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header styles */
    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--color-bg-primary);
    }

    h1 {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .header-controls {
      display: flex;
      gap: 8px;
    }

    /* Button styles */
    button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      border-radius: 4px;
      color: var(--color-text-secondary);
    }

    button:hover {
      background-color: var(--color-hover);
    }

    button svg {
      width: 16px;
      height: 16px;
    }

    .btn-group {
      display: flex;
      gap: 4px;
    }

    /* Main content and columns */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .column {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--color-border);
    }

    .column-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--color-bg-primary);
    }

    .column-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .column-content {
      flex: 1;
      padding: 12px 16px;
      overflow: auto;
      background-color: var(--color-bg-primary);
    }

    /* Input column */
    #json-input {
      width: 100%;
      height: 100%;
      resize: none;
      border: none;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.875rem;
      outline: none;
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
    }

    /* Tree view */
    .tree-node {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.875rem;
      margin-bottom: 2px;
    }

    .tree-content {
      display: flex;
      align-items: flex-start;
    }

    .tree-toggle {
      margin-right: 4px;
      cursor: pointer;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
    }

    .tree-label {
      color: var(--color-text-primary);
    }

    .tree-children {
      margin-left: 16px;
      position: relative;
    }

    .tree-children::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 0;
      height: 100%;
      width: 1px;
      background-color: var(--color-border);
    }

    /* Table view */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      background-color: var(--color-bg-secondary);
    }

    th {
      text-align: left;
      padding: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    td {
      padding: 8px;
      border-bottom: 1px solid var(--color-border-light);
      color: var(--color-text-primary);
    }

    tr:hover {
      background-color: var(--color-hover);
    }

    .table-toggle {
      margin-right: 4px;
      cursor: pointer;
      color: var(--color-text-secondary);
    }

    .nested-table {
      padding-left: 20px;
    }

    /* Value colors */
    .string-value {
      color: var(--color-string);
    }

    .number-value {
      color: var(--color-number);
    }

    .boolean-value {
      color: var(--color-boolean);
    }

    .null-value {
      color: var(--color-null);
    }

    /* Highlight search results */
    .search-highlight {
      background-color: rgba(250, 204, 21, 0.3);
      padding: 2px;
      border-radius: 2px;
    }

    #error-container {
      position: fixed;
      bottom: 12px;
      left: auto;
      right: auto;
      width: 100%;
      padding: 0 10%;
      z-index: 1000;
    }

    /* Error message */
    .error-message {
      margin-top: 16px;
      padding: 12px;
      background-color: var(--color-error-bg);
      border-radius: 4px;
      color: var(--color-error-text);
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .error-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .error-position {
      font-size: 0.875rem;
      margin-bottom: 12px;
    }

    .json-error-viewer {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre;
      overflow-x: auto;
      background-color: rgba(0, 0, 0, 0.05);
      padding: 8px;
      border-radius: 4px;
      line-height: 1.5;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      width: 100%;
    }

    .line-number {
      display: inline-block;
      width: 30px;
      color: var(--color-text-secondary);
      user-select: none;
      opacity: 0.7;
    }

    .json-line {
      white-space: pre;
    }

    .json-error-highlight {
      background-color: rgba(220, 38, 38, 0.3);
      border-radius: 2px;
      padding: 2px 0;
    }

    /* Empty state */
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--color-muted);
    }

    /* Theme toggle */
    .theme-toggle {
      margin-right: 8px;
    }

    /* Search container styles */
    .search-container {
      display: flex;
      align-items: center;
    }

    .search-container input {
      padding: 8px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      margin-right: 8px;
    }

    .search-container button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      color: var(--color-text-secondary);
    }

    .search-container button:hover {
      background-color: var(--color-hover);
    }

    .search-container button svg {
      width: 16px;
      height: 16px;
    }

    /* Search stats */
    .search-stats {
      display: flex;
      align-items: center;
      font-size: 0.75rem;
      margin-left: 8px;
      color: var(--color-text-secondary);
    }

    .search-stats button {
      padding: 2px;
    }

    /* JSON Stats */
    .json-stats {
      margin-top: 16px;
      padding: 12px;
      background-color: var(--color-bg-secondary);
      border-radius: 4px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      font-size: 0.875rem;
    }

    .stat-label {
      color: var(--color-text-secondary);
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <!-- Header with toggle controls -->
  <header>
    <h1>json2tree.com | JSON Visualizer | JSON to Tree</h1>
    <div class="header-controls">
      <!-- Tema claro/oscuro -->
      <button id="theme-toggle" class="theme-toggle" title="Cambiar tema">
        <svg id="theme-toggle-light-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg id="theme-toggle-dark-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar en JSON..." />
        <button id="search-btn" title="Buscar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
        <div id="search-stats" class="search-stats" style="display: none;">
          <span id="search-count">0</span> resultados
          <button id="prev-result" title="Resultado anterior">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button id="next-result" title="Siguiente resultado">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
      <button id="toggle-input" title="Toggle Input">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 18 22 12 16 6"></path>
          <path d="M8 6 2 12 8 18"></path>
        </svg>
      </button>
      <button id="toggle-tree" title="Toggle Tree View">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M13 2H9a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9z"></path>
          <path d="M13 2v7h7"></path>
          <path d="M9 16h6"></path>
          <path d="M9 12h6"></path>
        </svg>
      </button>
      <button id="toggle-table" title="Toggle Table View">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="3" y1="9" x2="21" y2="9"></line>
          <line x1="3" y1="15" x2="21" y2="15"></line>
          <line x1="9" y1="3" x2="9" y2="21"></line>
          <line x1="15" y1="3" x2="15" y2="21"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main content with columns -->
  <div id="error-container"></div>
  <div class="main-content" id="main-content">
    <!-- Input Column -->
    <div class="column" id="input-column">
      <div class="column-header">
        <div class="column-title">JSON Input</div>
        <div class="btn-group">
          <button id="format-btn">Format</button>
          <button id="clear-btn">Clear</button>
        </div>
      </div>
      <div class="column-content">
        <textarea id="json-input" placeholder="Paste your JSON here..."></textarea>
        <div id="json-stats" class="json-stats" style="display: none;">
          <div><span class="stat-label">Objetos:</span> <span id="object-count">0</span></div>
          <div><span class="stat-label">Arrays:</span> <span id="array-count">0</span></div>
          <div><span class="stat-label">Strings:</span> <span id="string-count">0</span></div>
          <div><span class="stat-label">Números:</span> <span id="number-count">0</span></div>
          <div><span class="stat-label">Booleanos:</span> <span id="boolean-count">0</span></div>
          <div><span class="stat-label">Nulos:</span> <span id="null-count">0</span></div>
        </div>
      </div>
    </div>

    <!-- Tree View Column -->
    <div class="column" id="tree-column" style="display: none;">
      <div class="column-header">
        <div class="column-title">Tree View</div>
        <div class="btn-group">
          <button id="expand-all-tree">Expand All</button>
          <button id="collapse-all-tree">Collapse all</button>
        </div>
      </div>
      <div class="column-content" id="tree-container"></div>
    </div>

    <!-- Table View Column -->
    <div class="column" id="table-column" style="display: none;">
      <div class="column-header">
        <div class="column-title">Table View</div>
        <div class="btn-group">
          <button id="expand-all-table">Expand All</button>
          <button id="collapse-all-table">Collapse All</button>
        </div>
      </div>
      <div class="column-content" id="table-container"></div>
    </div>
  </div>

  <script>
    // DOM Elements
    const jsonInput = document.getElementById('json-input');
    const formatBtn = document.getElementById('format-btn');
    const clearBtn = document.getElementById('clear-btn');
    const errorContainer = document.getElementById('error-container');
    const treeContainer = document.getElementById('tree-container');
    const tableContainer = document.getElementById('table-container');
    const inputColumn = document.getElementById('input-column');
    const treeColumn = document.getElementById('tree-column');
    const tableColumn = document.getElementById('table-column');
    const mainContent = document.getElementById('main-content');
    const toggleInputBtn = document.getElementById('toggle-input');
    const toggleTreeBtn = document.getElementById('toggle-tree');
    const toggleTableBtn = document.getElementById('toggle-table');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const expandAllTreeBtn = document.getElementById('expand-all-tree');
    const collapseAllTreeBtn = document.getElementById('collapse-all-tree');
    const expandAllTableBtn = document.getElementById('expand-all-table');
    const collapseAllTableBtn = document.getElementById('collapse-all-table');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchStats = document.getElementById('search-stats');
    const searchCount = document.getElementById('search-count');
    const prevResultBtn = document.getElementById('prev-result');
    const nextResultBtn = document.getElementById('next-result');
    const jsonStats = document.getElementById('json-stats');
    const objectCount = document.getElementById('object-count');
    const arrayCount = document.getElementById('array-count');
    const stringCount = document.getElementById('string-count');
    const numberCount = document.getElementById('number-count');
    const booleanCount = document.getElementById('boolean-count');
    const nullCount = document.getElementById('null-count');

    // State
    let parsedJson = null;
    let showInput = true;
    let showTree = false;
    let showTable = false;
    let searchResults = [];
    let currentResultIndex = -1;

    // Theme management
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      // Update theme toggle icons
      if (theme === 'dark') {
        themeToggleDarkIcon.style.display = 'none';
        themeToggleLightIcon.style.display = 'block';
      } else {
        themeToggleDarkIcon.style.display = 'block';
        themeToggleLightIcon.style.display = 'none';
      }
    }

    // Check for saved theme preference or respect OS preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setTheme('dark');
    } else {
      setTheme('light');
    }

    // Cargar JSON guardado
    const savedJson = localStorage.getItem('jsonData');
    if (savedJson) {
      jsonInput.value = savedJson;
      try {
        parsedJson = JSON.parse(savedJson);
        updateViews();
      } catch (err) {
        // Ignorar si hay error en el JSON guardado
      }
    }

    // Event Listeners
    formatBtn.addEventListener('click', formatJson);
    clearBtn.addEventListener('click', clearAll);
    toggleInputBtn.addEventListener('click', () => toggleColumn('input'));
    toggleTreeBtn.addEventListener('click', () => toggleColumn('tree'));
    toggleTableBtn.addEventListener('click', () => toggleColumn('table'));
    themeToggleBtn.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      setTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // Save JSON data on change
    jsonInput.addEventListener('input', () => {
      localStorage.setItem('jsonData', jsonInput.value);
    });

    // Auto-format JSON when pasting
    jsonInput.addEventListener('paste', (e) => {
      // Uso setTimeout para dejar que primero se complete el evento paste
      setTimeout(() => {
        const pastedText = jsonInput.value.trim();
        if (pastedText) {
          try {
            JSON.parse(pastedText);
            formatJson();
          } catch (err) {
            showJsonError(`${err.message}`, pastedText);
          }
        }
      }, 0);
    });

    // Función auxiliar para verificar si un texto es JSON válido
    function isValidJSON(text) {
      try {
        JSON.parse(text);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Expand/Collapse all tree nodes
    expandAllTreeBtn.addEventListener('click', () => {
      const toggleButtons = treeContainer.querySelectorAll('.tree-toggle');
      toggleButtons.forEach(btn => {
        const childrenContainer = btn.parentNode.nextElementSibling;
        if (childrenContainer && childrenContainer.style.display === 'none') {
          childrenContainer.style.display = 'block';
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          `;
        }
      });
    });

    collapseAllTreeBtn.addEventListener('click', () => {
      const toggleButtons = treeContainer.querySelectorAll('.tree-toggle');
      toggleButtons.forEach(btn => {
        const childrenContainer = btn.parentNode.nextElementSibling;
        if (childrenContainer && childrenContainer.style.display !== 'none') {
          childrenContainer.style.display = 'none';
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          `;
        }
      });
    });

    // Expand/Collapse all table rows
    expandAllTableBtn.addEventListener('click', () => {
      const toggleButtons = tableContainer.querySelectorAll('.table-toggle');
      toggleButtons.forEach(btn => {
        const row = btn.closest('tr');
        const nextRow = row.nextElementSibling;
        if (nextRow && nextRow.style.display === 'none') {
          nextRow.style.display = 'table-row';
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          `;
        }
      });
    });

    collapseAllTableBtn.addEventListener('click', () => {
      const toggleButtons = tableContainer.querySelectorAll('.table-toggle');
      toggleButtons.forEach(btn => {
        const row = btn.closest('tr');
        const nextRow = row.nextElementSibling;
        if (nextRow && nextRow.style.display !== 'none') {
          nextRow.style.display = 'none';
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          `;
        }
      });
    });

    // Search functionality
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // Navigation between search results
    prevResultBtn.addEventListener('click', () => {
      if (currentResultIndex > 0) {
        currentResultIndex--;
        highlightResult(currentResultIndex);
      }
    });

    nextResultBtn.addEventListener('click', () => {
      if (currentResultIndex < searchResults.length - 1) {
        currentResultIndex++;
        highlightResult(currentResultIndex);
      }
    });

    function performSearch() {
      const searchTerm = searchInput.value.trim().toLowerCase();
      if (!searchTerm || !parsedJson) return;

      // Clear previous highlights
      clearSearchHighlights();

      // Find all matches in tree and table views
      searchResults = [];

      // Search in tree view
      findMatchesInTree(treeContainer, searchTerm);

      // Search in table view
      findMatchesInTable(tableContainer, searchTerm);

      // Update search stats
      searchCount.textContent = searchResults.length;
      searchStats.style.display = searchResults.length > 0 ? 'flex' : 'none';

      // Highlight first result if any found
      if (searchResults.length > 0) {
        currentResultIndex = 0;
        highlightResult(currentResultIndex);
      }
    }

    function findMatchesInTree(container, searchTerm) {
      const treeNodes = container.querySelectorAll('.tree-label');

      treeNodes.forEach(node => {
        const text = node.textContent.toLowerCase();

        if (text.includes(searchTerm)) {
          searchResults.push({
            element: node,
            type: 'tree'
          });

          // Highlight the matching text
          highlightTextInNode(node, searchTerm);

          // Expand all parent nodes to show the match
          expandParents(node);
        }
      });
    }

    function findMatchesInTable(container, searchTerm) {
      const tableCells = container.querySelectorAll('td');

      tableCells.forEach(cell => {
        const text = cell.textContent.toLowerCase();

        if (text.includes(searchTerm)) {
          searchResults.push({
            element: cell,
            type: 'table'
          });

          // Highlight the matching text
          highlightTextInNode(cell, searchTerm);

          // Expand parent row to show the match if it's in a nested table
          const row = cell.closest('tr');
          if (row.classList.contains('nested-row')) {
            row.style.display = 'table-row';
          }
        }
      });
    }

    function highlightTextInNode(node, searchTerm) {
      const text = node.textContent;
      const lowerText = text.toLowerCase();
      const searchTermLower = searchTerm.toLowerCase();

      let html = '';
      let lastIndex = 0;

      let index = lowerText.indexOf(searchTermLower);
      while (index !== -1) {
        // Add text before the match
        html += text.substring(lastIndex, index);

        // Add the highlighted match
        html += `<span class="search-highlight">${text.substring(index, index + searchTerm.length)}</span>`;

        lastIndex = index + searchTerm.length;
        index = lowerText.indexOf(searchTermLower, lastIndex);
      }

      // Add any remaining text
      html += text.substring(lastIndex);

      node.innerHTML = html;
    }

    function expandParents(node) {
      let current = node;

      // Navigate up to find tree-children containers and expand them
      while (current && current !== treeContainer) {
        if (current.classList.contains('tree-children') && current.style.display === 'none') {
          current.style.display = 'block';

          // Update the toggle button
          const parentContent = current.previousElementSibling;
          if (parentContent && parentContent.classList.contains('tree-content')) {
            const toggleBtn = parentContent.querySelector('.tree-toggle');
            if (toggleBtn) {
              toggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              `;
            }
          }
        }

        current = current.parentNode;
      }
    }

    function clearSearchHighlights() {
      // Clear highlights in tree view
      const treeHighlights = treeContainer.querySelectorAll('.search-highlight');
      treeHighlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.textContent = parent.textContent; // Simple way to remove all HTML and keep just text
      });

      // Clear highlights in table view
      const tableHighlights = tableContainer.querySelectorAll('.search-highlight');
      tableHighlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.textContent = parent.textContent;
      });

      searchResults = [];
      currentResultIndex = -1;
    }

    function highlightResult(index) {
      if (index < 0 || index >= searchResults.length) return;

      const result = searchResults[index];
      result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // Make sure the view container is visible
      if (result.type === 'tree' && !showTree) {
        showTree = true;
        updateColumnVisibility();
      } else if (result.type === 'table' && !showTable) {
        showTable = true;
        updateColumnVisibility();
      }
    }

    // Functions
    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // Función mejorada para mostrar errores JSON con posición
    function showJsonError(errorMessage, jsonText) {
      // Limpiar cualquier error anterior
      errorContainer.innerHTML = '';

      // Extraer la posición del error del mensaje (si existe)
      const positionMatch = errorMessage.match(/position (\d+)/i);
      let errorPosition = positionMatch ? parseInt(positionMatch[1]) : -1;

      // Crear el contenedor principal del error
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';

      // Añadir título del error
      const errorTitle = document.createElement('div');
      errorTitle.className = 'error-title';
      errorTitle.textContent = `Error de JSON: ${errorMessage}`;
      errorDiv.appendChild(errorTitle);

      // Si encontramos una posición válida
      if (errorPosition >= 0) {
        // Añadir información de posición
        const errorPos = document.createElement('div');
        errorPos.className = 'error-position';
        errorPos.textContent = `Error en la posición ${errorPosition}`;
        errorDiv.appendChild(errorPos);

        // Calcular la línea y columna aproximada del error
        let line = 1;
        let column = 0;
        let isErrorHighlighted = false;

        // Formatear el JSON con numeración de líneas y resaltado de error
        const viewerDiv = document.createElement('div');
        viewerDiv.className = 'json-error-viewer';

        let formattedHtml = '';

        for (let i = 0; i < jsonText.length; i++) {
          // Nueva línea
          if (jsonText[i] === '\n' || i === 0) {
            if (i !== 0) {
              formattedHtml += '</span>\n';
              line++;
              column = 0;
            }

            // Añadir número de línea
            formattedHtml += `<span class="line-number">${line}</span><span class="json-line">`;
          }

          // Resaltar posición del error
          if (i === errorPosition) {
            formattedHtml += '<span class="json-error-highlight">';
            isErrorHighlighted = true;
          }

          // Escapar caracteres HTML
          let char = jsonText[i];
          if (char === '<') char = '&lt;';
          else if (char === '>') char = '&gt;';
          else if (char === '&') char = '&amp;';

          // Añadir carácter
          if (char !== '\n' || i === 0) {
            formattedHtml += char;
            column++;
          }

          // Cerrar span de error después de algunos caracteres
          if (isErrorHighlighted && (i >= errorPosition + 5 || i === jsonText.length - 1)) {
            formattedHtml += '</span>';
            isErrorHighlighted = false;
          }
        }

        // Cerrar el último span de línea
        formattedHtml += '</span>';

        viewerDiv.innerHTML = formattedHtml;
        errorDiv.appendChild(viewerDiv);
      }

      // Añadir al contenedor
      errorContainer.appendChild(errorDiv);
    }

    function formatJson() {
      const input = jsonInput.value.trim();
      errorContainer.innerHTML = '';
      jsonStats.style.display = 'none';

      if (!input) {
        showError('Please enter JSON data');
        parsedJson = null;
        updateViews();
        return;
      }

      try {
        parsedJson = JSON.parse(input);
        jsonInput.value = JSON.stringify(parsedJson, null, 2);
        localStorage.setItem('jsonData', jsonInput.value);
        showTree = true;
        showTable = true;
        updateColumnVisibility();
        updateViews();
        calculateJsonStats(parsedJson);
      } catch (err) {
        showJsonError(`${err.message}`, input);
        parsedJson = null;
        updateViews();
      }
    }

    function clearAll() {
      jsonInput.value = '';
      errorContainer.innerHTML = '';
      parsedJson = null;
      localStorage.removeItem('jsonData');
      jsonStats.style.display = 'none';
      searchStats.style.display = 'none';
      updateViews();
    }

    function toggleColumn(column) {
      if (column === 'input') {
        showInput = !showInput;
      } else if (column === 'tree') {
        showTree = !showTree;
      } else if (column === 'table') {
        showTable = !showTable;
      }

      updateColumnVisibility();
    }

    function updateColumnVisibility() {
      // Make sure at least one column is visible
      if (!showInput && !showTree && !showTable) {
        showInput = true;
      }

      // Update column display
      inputColumn.style.display = showInput ? 'flex' : 'none';
      treeColumn.style.display = showTree && parsedJson ? 'flex' : 'none';
      tableColumn.style.display = showTable && parsedJson ? 'flex' : 'none';

      // Calculate column widths
      const visibleCount = [showInput, showTree && parsedJson, showTable && parsedJson].filter(Boolean).length;
      const width = `${100 / visibleCount}%`;

      if (showInput) inputColumn.style.width = width;
      if (showTree && parsedJson) treeColumn.style.width = width;
      if (showTable && parsedJson) tableColumn.style.width = width;

      // Add empty state if needed
      if (mainContent.children.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.textContent = 'All panels are hidden. Click the toggle buttons to show content.';
        mainContent.appendChild(emptyState);
      } else {
        const emptyState = mainContent.querySelector('.empty-state');
        if (emptyState) emptyState.remove();
      }
    }

    function updateViews() {
      if (parsedJson) {
        renderTreeView(parsedJson);
        renderTableView(parsedJson);
      } else {
        treeContainer.innerHTML = '';
        tableContainer.innerHTML = '';
      }
      updateColumnVisibility();
    }

    // Tree View Rendering
    function renderTreeView(data) {
      treeContainer.innerHTML = '';
      const treeRoot = createTreeNode(data);
      treeContainer.appendChild(treeRoot);
    }

    function createTreeNode(data, key, level = 0) {
      const nodeContainer = document.createElement('div');
      nodeContainer.className = 'tree-node';

      const nodeContent = document.createElement('div');
      nodeContent.className = 'tree-content';

      const isObject = data !== null && typeof data === 'object';
      const isArray = Array.isArray(data);

      // Create toggle button for objects and arrays
      const toggleBtn = document.createElement('div');
      toggleBtn.className = 'tree-toggle';

      if (isObject) {
        toggleBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        `;
      } else {
        toggleBtn.style.visibility = 'hidden';
      }

      nodeContent.appendChild(toggleBtn);

      // Create label
      const label = document.createElement('span');
      label.className = 'tree-label';

      if (key !== undefined) {
        if (isObject) {
          const count = isArray ? data.length : Object.keys(data).length;
          label.textContent = `${key}: ${isArray ? '[' : '{'} ${count} ${count === 1 ? 'item' : 'items'} ${isArray ? ']' : '}'}`;
        } else {
          label.textContent = `${key}: `;

          // Add value with appropriate styling
          const value = document.createElement('span');
          if (data === null) {
            value.className = 'null-value';
            value.textContent = 'null';
          } else if (typeof data === 'string') {
            value.className = 'string-value';
            value.textContent = `"${data}"`;
          } else if (typeof data === 'number') {
            value.className = 'number-value';
            value.textContent = data;
          } else if (typeof data === 'boolean') {
            value.className = 'boolean-value';
            value.textContent = data;
          } else {
            value.textContent = data;
          }
          label.appendChild(value);
        }
      } else {
        if (isArray) {
          label.textContent = `Array [${data.length}]`;
        } else if (isObject) {
          label.textContent = `Object {${Object.keys(data).length}}`;
        } else {
          label.textContent = String(data);
        }
      }

      nodeContent.appendChild(label);
      nodeContainer.appendChild(nodeContent);

      // Create children container for objects and arrays
      if (isObject) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'tree-children';

        if (isArray) {
          data.forEach((item, index) => {
            const childNode = createTreeNode(item, String(index), level + 1);
            childrenContainer.appendChild(childNode);
          });
        } else {
          Object.entries(data).forEach(([childKey, value]) => {
            const childNode = createTreeNode(value, childKey, level + 1);
            childrenContainer.appendChild(childNode);
          });
        }

        nodeContainer.appendChild(childrenContainer);

        // Toggle functionality
        toggleBtn.addEventListener('click', () => {
          const isExpanded = childrenContainer.style.display !== 'none';
          childrenContainer.style.display = isExpanded ? 'none' : 'block';
          toggleBtn.innerHTML = isExpanded
            ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
        });

        // Auto-collapse deeper levels
        if (level >= 2) {
          childrenContainer.style.display = 'none';
          toggleBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          `;
        }
      }

      return nodeContainer;
    }

    // Table View Rendering
    function renderTableView(data) {
      tableContainer.innerHTML = '';

      if (Array.isArray(data)) {
        tableContainer.appendChild(createArrayTable(data));
      } else if (typeof data === 'object' && data !== null) {
        tableContainer.appendChild(createObjectTable(data));
      } else {
        tableContainer.textContent = String(data);
      }
    }

    function createObjectTable(data, level = 0) {
      const table = document.createElement('table');

      // Create header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const keyHeader = document.createElement('th');
      keyHeader.textContent = 'Key';
      keyHeader.style.width = '30%';
      const valueHeader = document.createElement('th');
      valueHeader.textContent = 'Value';

      headerRow.appendChild(keyHeader);
      headerRow.appendChild(valueHeader);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Create body
      const tbody = document.createElement('tbody');

      Object.entries(data).forEach(([key, value]) => {
        const isComplex = value !== null && typeof value === 'object';

        // Create main row
        const row = document.createElement('tr');
        const keyCell = document.createElement('td');
        const valueCell = document.createElement('td');

        // Key cell with toggle for complex values
        if (isComplex) {
          const toggleBtn = document.createElement('span');
          toggleBtn.className = 'table-toggle';
          toggleBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          `;
          keyCell.appendChild(toggleBtn);
        }

        const keyText = document.createTextNode(key);
        keyCell.appendChild(keyText);
        row.appendChild(keyCell);

        // Value cell
        if (!isComplex) {
          if (value === null) {
            valueCell.innerHTML = '<span class="null-value">null</span>';
          } else if (typeof value === 'string') {
            valueCell.innerHTML = `<span class="string-value">"${value}"</span>`;
          } else if (typeof value === 'number') {
            valueCell.innerHTML = `<span class="number-value">${value}</span>`;
          } else if (typeof value === 'boolean') {
            valueCell.innerHTML = `<span class="boolean-value">${value}</span>`;
          } else {
            valueCell.textContent = String(value);
          }
        } else {
          const count = Array.isArray(value) ? value.length : Object.keys(value).length;
          valueCell.innerHTML = `<span class="muted">${Array.isArray(value) ? 'Array' : 'Object'} (${count} ${count === 1 ? 'item' : 'items'})</span>`;
        }

        row.appendChild(valueCell);
        tbody.appendChild(row);

        // Create nested table row for complex values
        if (isComplex) {
          const nestedRow = document.createElement('tr');
          nestedRow.style.display = 'none';

          const nestedCell = document.createElement('td');
          nestedCell.colSpan = 2;
          nestedCell.className = 'nested-table';

          const nestedTable = Array.isArray(value)
            ? createArrayTable(value, level + 1)
            : createObjectTable(value, level + 1);

          nestedCell.appendChild(nestedTable);
          nestedRow.appendChild(nestedCell);
          tbody.appendChild(nestedRow);

          // Toggle functionality
          const toggleBtn = keyCell.querySelector('.table-toggle');
          toggleBtn.addEventListener('click', () => {
            const isExpanded = nestedRow.style.display !== 'none';
            nestedRow.style.display = isExpanded ? 'none' : 'table-row';
            toggleBtn.innerHTML = isExpanded
              ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`
              : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
          });
        }
      });

      table.appendChild(tbody);
      return table;
    }

    function createArrayTable(data, level = 0) {
      const table = document.createElement('table');

      // Create header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const indexHeader = document.createElement('th');
      indexHeader.textContent = 'Index';
      indexHeader.style.width = '30%';
      const valueHeader = document.createElement('th');
      valueHeader.textContent = 'Value';

      headerRow.appendChild(indexHeader);
      headerRow.appendChild(valueHeader);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Create body
      const tbody = document.createElement('tbody');

      data.forEach((value, index) => {
        const isComplex = value !== null && typeof value === 'object';

        // Create main row
        const row = document.createElement('tr');
        const indexCell = document.createElement('td');
        const valueCell = document.createElement('td');

        // Index cell with toggle for complex values
        if (isComplex) {
          const toggleBtn = document.createElement('span');
          toggleBtn.className = 'table-toggle';
          toggleBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          `;
          indexCell.appendChild(toggleBtn);
        }

        const indexText = document.createTextNode(index);
        indexCell.appendChild(indexText);
        row.appendChild(indexCell);

        // Value cell
        if (!isComplex) {
          if (value === null) {
            valueCell.innerHTML = '<span class="null-value">null</span>';
          } else if (typeof value === 'string') {
            valueCell.innerHTML = `<span class="string-value">"${value}"</span>`;
          } else if (typeof value === 'number') {
            valueCell.innerHTML = `<span class="number-value">${value}</span>`;
          } else if (typeof value === 'boolean') {
            valueCell.innerHTML = `<span class="boolean-value">${value}</span>`;
          } else {
            valueCell.textContent = String(value);
          }
        } else {
          const count = Array.isArray(value) ? value.length : Object.keys(value).length;
          valueCell.innerHTML = `<span class="muted">${Array.isArray(value) ? 'Array' : 'Object'} (${count} ${count === 1 ? 'item' : 'items'})</span>`;
        }

        row.appendChild(valueCell);
        tbody.appendChild(row);

        // Create nested table row for complex values
        if (isComplex) {
          const nestedRow = document.createElement('tr');
          nestedRow.style.display = 'none';

          const nestedCell = document.createElement('td');
          nestedCell.colSpan = 2;
          nestedCell.className = 'nested-table';

          const nestedTable = Array.isArray(value)
            ? createArrayTable(value, level + 1)
            : createObjectTable(value, level + 1);

          nestedCell.appendChild(nestedTable);
          nestedRow.appendChild(nestedCell);
          tbody.appendChild(nestedRow);

          // Toggle functionality
          const toggleBtn = indexCell.querySelector('.table-toggle');
          toggleBtn.addEventListener('click', () => {
            const isExpanded = nestedRow.style.display !== 'none';
            nestedRow.style.display = isExpanded ? 'none' : 'table-row';
            toggleBtn.innerHTML = isExpanded
              ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`
              : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
          });
        }
      });

      table.appendChild(tbody);
      return table;
    }

    // Calculate JSON statistics
    function calculateJsonStats(data) {
      // Reset counters
      let counts = {
        object: 0,
        array: 0,
        string: 0,
        number: 0,
        boolean: 0,
        null: 0
      };

      // Count recursively
      countTypes(data, counts);

      // Update DOM
      objectCount.textContent = counts.object;
      arrayCount.textContent = counts.array;
      stringCount.textContent = counts.string;
      numberCount.textContent = counts.number;
      booleanCount.textContent = counts.boolean;
      nullCount.textContent = counts.null;

      // Show stats
      jsonStats.style.display = 'grid';
    }

    function countTypes(data, counts) {
      if (data === null) {
        counts.null++;
      }
      else if (Array.isArray(data)) {
        counts.array++;
        data.forEach(item => countTypes(item, counts));
      }
      else if (typeof data === 'object') {
        counts.object++;
        Object.values(data).forEach(value => countTypes(value, counts));
      }
      else if (typeof data === 'string') {
        counts.string++;
      }
      else if (typeof data === 'number') {
        counts.number++;
      }
      else if (typeof data === 'boolean') {
        counts.boolean++;
      }
    }

    // Initialize
    updateColumnVisibility();
  </script>
</body>

</html>
